<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoDom - Вход</title>
    <meta name="description" content="Вход в систему умного дома EcoDom. Управление домом через Raspberry Pi и смартфон">
    <meta name="keywords" content="умный дом, ecodom, raspberry pi, безопасность дома, видеонаблюдение">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div class="login-wrapper">
        <div class="login-container">
            <!-- Языковой переключатель -->
            <div class="login-language-switcher">
                <button class="lang-btn" data-lang="ru">RU</button>
                <button class="lang-btn" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="kz">KZ</button>
            </div>
            
            <div class="login-logo">
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="45" fill="#4CAF50"/>
                    <path d="M30,30 L70,70 M70,30 L30,70" stroke="white" stroke-width="8"/>
                </svg>
            </div>
            <h1 data-key="app.name">EcoDom</h1>
            <div id="loginStatus" style="display:none; padding:15px; border-radius:12px; margin-bottom:20px; background:#4CAF50; color:white;">
                <span data-key="login.auth">Авторизация...</span>
            </div>
            <div id="errorMessage" class="error-message"></div>
            <form id="loginForm">
                <div class="input-group">
                    <label for="rpi_id" data-key="login.rpi_id">ID Raspberry Pi</label>
                    <input type="text" id="rpi_id" required autocomplete="off" data-key-placeholder="login.rpi_placeholder">
                </div>
                <div class="input-group">
                    <label for="password" data-key="login.password">Пароль</label>
                    <input type="password" id="password" required autocomplete="current-password" data-key-placeholder="login.password_placeholder">
                </div>
                <button type="submit" id="loginButton" data-key="login.button">Войти</button>
            </form>
            
            <div class="temp-access">
                <p data-key="login.no_credentials">Нет учетных данных? Продолжите без входа (демо-режим)</p>
                <button id="tempAccessBtn" class="secondary" data-key="login.continue_without">Продолжить без входа</button>
            </div>
            
            <div class="login-footer">
                <p data-key="login.instructions">Используйте заводские логин и пароль с наклейки на Raspberry Pi, после входа вы сможете сменить пароль в настройках</p>
            </div>
            <p data-key="login.agreement">Используя сайт, вы соглашаетесь на сбор метаданных.</p>
        </div>
    </div>

    <!-- Общий менеджер языков -->
    <script src="language-manager.js"></script>

<script>
// Основной код страницы входа с использованием общего менеджера языков
document.addEventListener('DOMContentLoaded', function() {
    // Получаем экземпляр менеджера языков
    const langManager = window.languageManager;
    
    // Обработчик временного доступа
    const tempAccessBtn = document.getElementById('tempAccessBtn');
    if (tempAccessBtn) {
        tempAccessBtn.addEventListener('click', function() {
            localStorage.setItem('tempAccess', 'true');
            localStorage.removeItem('authToken');
            window.location.href = 'index.html';
        });
    }
    
    // Обработчик формы входа
    const loginForm = document.getElementById('loginForm');
    const loginButton = document.getElementById('loginButton');
    const errorDiv = document.getElementById('errorMessage');
    
    if (loginForm) {
        const handleLogin = async function(e) {
            if (e) e.preventDefault();
            
            loginButton.disabled = true;
            loginButton.textContent = langManager.get('login.auth');
            
            const rpiIdInput = document.getElementById('rpi_id').value.trim();
            const password = document.getElementById('password').value;
            
            if (!rpiIdInput || !password) {
                showError(langManager.get('login.error.fill_fields'));
                resetLoginButton();
                return;
            }
            
            showError(langManager.get('login.error.auth'));
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ 
                        rpi_id: rpiIdInput,
                        password: password
                    })
                });
                
                if (!response.ok) {
                    let errorMsg = `Ошибка сервера: ${response.status}`;
                    
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.error || errorMsg;
                    } catch (parseError) {
                        if (response.status === 500) {
                            errorMsg = langManager.get('login.error.server_error');
                        } else if (response.status === 404) {
                            errorMsg = langManager.get('login.error.device_not_found');
                        } else if (response.status === 401) {
                            errorMsg = langManager.get('login.error.wrong_password');
                        } else if (response.status === 400) {
                            errorMsg = langManager.get('login.error.bad_request');
                        }
                    }
                    
                    showError(errorMsg);
                    resetLoginButton();
                    return;
                }
                
                const data = await response.json();
                
                if (data.status === "success" && data.token) {
                    localStorage.setItem('authToken', data.token); // 
                    localStorage.setItem('rpiId', data.rpi_id || rpiIdInput);
                    localStorage.setItem('tg_password', password);              // хеш надо ------------------------------------------------------------
                    localStorage.removeItem('tempAccess');
                    window.location.href = 'index.html';
                } else {
                    showError(data.error || 'Неизвестная ошибка авторизации');
                    resetLoginButton();
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showError(langManager.get('login.error.server'));
                resetLoginButton();
            }
        };

        function showError(message) {
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = "block";
                errorDiv.style.background = "#f44336";
                errorDiv.style.color = "white";
                errorDiv.style.padding = "10px";
                errorDiv.style.borderRadius = "5px";
                errorDiv.style.marginBottom = "15px";
            }
        }
        
        function resetLoginButton() {
            if (loginButton) {
                loginButton.disabled = false;
                loginButton.textContent = langManager.get('login.button');
            }
        }
        
        loginForm.addEventListener('submit', handleLogin);
        
        // Автоматический вызов при нажатии Enter
        document.getElementById('rpi_id').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin(e);
        });
        
        document.getElementById('password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin(e);
        });
    }
});
</script>
</body>
</html>
